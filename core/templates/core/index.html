{% extends 'core/base.html' %}
{% load static %}
{% block content %}
<div class="container-fluid" style="padding-bottom: 200px;">
    {% if popup_text %}
      <script type="text/javascript">
        $(window).on('load',function(){
          $('#popup').modal('show');
        });
        function copyToClipboard() {
          var copyText = document.getElementById("popup_textarea");
          copyText.select();
          document.execCommand("copy");
          $('#popup').modal('hide');
        }
      </script>
    {% endif %}
    <div class="modal fade" id="popup" tabindex="-1" role="dialog" aria-labelledby="responseLabel" aria-hidden="true" style="z-index: 11111;">
      <div class="modal-dialog modal-dialog-pop-up" role="document">
        <div class="modal-content" style="height: 500px;">
          <div class="modal-header">
            <h5 class="modal-title" id="responseLabel">Response:</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <textarea id="popup_textarea" class="form-control">{{popup_text|safe}}</textarea>
          </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <input type="button" class="btn btn-primary" value="Copy to the clipboard" onclick="copyToClipboard()"></button>
            </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="pool_list" tabindex="-1" role="dialog" aria-labelledby="pool_list_modal" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <form action="{% url 'add_pool_node' %}" method="post">
            {% csrf_token %}
            <div class="modal-header">
              <h5 class="modal-title" id="pool_list_modal">Pool List:</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <input name="pool_ip" class="form-control bg-light border-0 small col-md-6 mb-4" placeholder="https://1.2.3.4:8000" required/>
              <textarea class="form-control">{{ pool_list | join:"&#10;" }}</textarea>
              <h5 class="modal-title">My services:</h5>
              <textarea class="form-control">{{ my_services | join:"&#10;" }}</textarea>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <input type="submit" class="btn btn-primary" value="Add pool node"></button>
            </div>
          </form>
          {% if not ngrokService and not is_heroku %}
            <div class="modal-body">
              <hr class='sidebar-divider my-0 my-separator'>
              <div style="display: flex;">
                <form action="{% url 'startNgrok' %}" method="post" id="startNgrok" name="startNgrok" style="margin: 0 10px;">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-info">Init ngrok</button>
                </form>
                <form action="{% url 'startNgrok' %}" method="post" id="startNgrok" name="startNgrok" style="margin: 0 10px;">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-info">Init ngrok</button>
                </form>
                <form action="{% url 'startNgrok' %}" method="post" id="startNgrok" name="startNgrok" style="margin: 0 10px;">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-info">Init ngrok</button>
                </form>
              </div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
      <h1 class="h3 mb-0 text-gray-800">Dashboard</h1>
      <div class="d-sm-flex align-items-center justify-content-between mb-6">
        {% comment %} <input type="text" class="form-control" id="my_pool_id" value="{{my_node_id_pool}}" size="{{my_node_id_pool|length}}" onfocus="copyNodeIdToClipboard()" readonly/> |  {% endcomment %}
        <form id="switchPoolForm">
          {% csrf_token %}
          <div class="custom-control custom-switch">
            <input type="checkbox" class="custom-control-input" id="checkSwitchPool" {% if status_pool %} checked {% endif %}>
            <label class="custom-control-label" for="checkSwitchPool">On/Off the Pool</label>
          </div>
          <!--<input id="checkSwitchPool" type="checkbox" style="border: 0px !important;" data-toggle="toggle" data-on="Enabled" data-off="Disabled" data-size="small" data-offstyle="danger" data-onstyle="{% if pool_list|length > 0 %}success{% else %}primary{% endif %}" {% if status_pool %}checked{% endif %}>-->
        </form>
        <script>
          $(function() {
            $('#checkSwitchPool').change(function(e) {
              e.preventDefault();
              //$("#switchPoolForm").submit();
              $.ajax({
                headers: { "X-CSRFToken": '{{csrf_token}}' },
                url : "{% url 'switchPool' %}", // the endpoint
                type : "POST", // http method
                async: true,
                data : { csrfmiddlewaretoken : '{{ csrf_token }}' },
                success : function(res) {
                    if('status' in res && res.status == true){
                      $('input:checkbox[id^="__pool_it_"]').each(function(){
                        document.getElementById($(this).attr('id')).parentElement.parentElement.style.display = "block";
                      });
                    } else {
                      if('status' in res && res.status == false){
                        $('input:checkbox[id^="__pool_it_"]').each(function(){
                          var a = document.getElementById($(this).attr('id')).parentElement.parentElement.style.display = "None";
                        });
                      }
                    }
                },
                error : function(xhr,errmsg,err) {
                    console.log(xhr.status + ": " + xhr.responseText);
                }
              });
            })
          })
        </script>
        <a href="#" href="#" data-toggle="modal" data-target="#pool_list" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm"><i class="fas fa-upload fa-sm text-white-50"></i> Pool List ({{pool_list|length}})</a> | 
        <a href="{% url 'config_look_for_changes' %}" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm"><i class="fas fa-download fa-sm text-white-50"></i> Refresh Config</a> | 
        <a id="restartServerButton" style="color: white;" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm"><i class="fas fa-download fa-sm text-white-50"></i> Restart Server</a>
        <script>
          $('#restartServerButton').click(function(){
            $.ajax({
                url : "{% url 'restartServerDjango' %}", // the endpoint
                type : "POST", // http method
                data : { csrfmiddlewaretoken : '{{ csrf_token }}' },
                async: true,
                success : function(res) {
                  $.notify("Restart server:\n" + res['data'], "warn");
                  $.each($('.modal'), function(){
                    $(this).modal('hide');
                  });
                  $('#reloading-server').modal('show');
                  changeGif(Math.floor(Math.random() * 4) + 1);
                },
                error : function(xhr,errmsg,err) {
                  $.notify("Restart server:\n" + xhr.status + ": " + xhr.responseText, "error");
                  console.log(xhr.status + ": " + xhr.responseText);
                }
              });
          });
        </script>
      </div>
    </div>

    <!-- Content Row -->
    <div class="row">
      <!-- Modal create Module -->
      <div class="modal fade" id="createModuleModal" tabindex="-1" role="dialog" aria-labelledby="createModuleLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <form action="{% url 'createmod' %}" method="post">
              {% csrf_token %}
              <div class="modal-header">
                <h5 class="modal-title" id="createModuleLabel">Create new Module</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <input name="module_name" class="form-control bg-light border-0 small col-md-6 mb-4" placeholder="Module name" required/>
                <span>Category:</span><br />
                <select id="editable-select" name="category_name" class="custom-select custom-select-sm form-control form-control-sm col-xl-3 col-md-6 mb-4">
                  {% for cat in categories %}
                    <option value="{{cat}}">{{cat}}</option>
                  {% endfor %}
                </select>
                <script>
                  $('#editable-select').editableSelect();
                </script>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <input type="submit" class="btn btn-primary" value="Save changes"></button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <div class="col-xl-3 col-md-6 mb-4">
        <a href="#" data-toggle="modal" data-target="#createModuleModal">
          <div class="card border-left-success shadow h-100 py-2 overMouseButtons">
            <div class="card-body">
              <div class="row no-gutters align-items-center">
                <div class="col mr-2">
                  <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">{{modules|length}} Modules - {{categories|length}} Categories Loaded</div>
                  <div class="h5 mb-0 font-weight-bold text-gray-800">Create Module</div>
                </div>
                <div class="col-auto">
                  <i class="fas fa-edit fa-2x text-gray-300"></i>
                </div>
              </div>
            </div>
          </div>
        </a>
      </div>

      <!-- Modal config Module -->
      <div class="modal fade" id="configModuleModal" tabindex="-1" role="dialog" aria-labelledby="configModuleLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-bigger" role="document">
          <div class="modal-content">
            <form action="{% url 'configmod' %}" method="post">
              {% csrf_token %}
              <div class="modal-header">
                <h5 class="modal-title" id="configModuleLabel">Configure Module</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <div class="container">
                  <div id="bs-ml-treetable" class="treetable">
                    Loading ...
                  </div>
                </div>
                <script type="text/javascript" src="{% static 'core/js/jquery.edittreetable.js' %}"></script>
                <script type="text/javascript">
                  var data = [{{modules_config_treeview|safe}}];

                  $("#bs-ml-treetable").bstreetable({
                    data:data,
                    maintitle:"Key",
                    nodeaddCallback:function(data,callback){
                      alert(JSON.stringify(data));
                      callback({id:18,name:data.name,innercode:"ttttt",pid:data.pid});
                    },
                    noderemoveCallback:function(data,callback){
                      alert(JSON.stringify(data));
                      callback();
                    },
                    nodeupdateCallback:function(data,callback){
                      alert(JSON.stringify(data));
                      callback();
                    },
                    extfield:[
                      {title:"Value",key:"value",type:"input"}
                    ]
                  });
                </script>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <input type="submit" class="btn btn-primary" value="Save module"></button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <!-- Earnings (Monthly) Card Example -->
      <div class="col-xl-3 col-md-6 mb-4">
        <a href="#" data-toggle="modal" data-target="#configModuleModal">
          <div class="card border-left-info shadow h-100 py-2 overMouseButtons">
            <div class="card-body">
              <div class="row no-gutters align-items-center">
                <div class="col mr-2">
                  <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Change your configuration</div>
                  <div class="h5 mb-0 font-weight-bold text-gray-800">Config Modules</div>
                </div>
                <div class="col-auto">
                  <i class="fas fa-cogs fa-2x text-gray-300"></i>
                </div>
              </div>
            </div>
          </div>
        </a>
      </div>

      <!-- Modal create Script -->
      <div class="modal fade" id="createScriptModuleModal" tabindex="-1" role="dialog" aria-labelledby="createScriptModuleLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-bigger" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="createScriptModuleLabel">Create Script</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body modal-body-limited">
              <div class="row">
                {% for name, funct in modules_all.items %}
                  <div class="col-lg-3 mb-3">
                    <h3>{{name}}</h3>
                    <div class="moduleFunctions">
                      {% if funct.items|length > 1 %}
                        {% for funct_name, funct_params in funct.items %}
                          {% if funct_name != 'help' %}
                            {% for tool, function in modules_functions_modals.items %}
                              {% for functi, data in function.items %}
                                {% if functi == funct_name and 'ht_'|add:name == tool %}
                                  <!-- MODAL PARA LA FUNCTION -->
                                  <div class="modal fade" id="testModuleFunctionModal_{{tool}}_{{functi}}" tabindex="-1" role="dialog" aria-labelledby="testModuleFunctionModalLabel_{{tool}}_{{functi}}" aria-hidden="true">
                                    <div class="modal-dialog" role="document">
                                      <div class="modal-content">
                                        {% for data_key, data_value in data.items %}
                                          {% if data_key in '__function__' %}
                                              <div class="modal-header">
                                                <h5 class="modal-title" id="testModuleFunctionModalLabel_{{tool}}_{{functi}}">Test {{functi}}</h5>
                                              </div><!-- -->
                                              <div class="modal-body">
                                                <form action="#" method="post" enctype="multipart/form-data" id="form_{{data_value}}">
                                                  {% csrf_token %}
                                                  {% for mod, modform in modules_forms_modal.items %}
                                                    {% for f_name, f_data_form in modform.items %}
                                                      {% if f_name == functi %}
                                                        {{f_data_form|safe}}
                                                      {% endif %}
                                                    {% endfor %}
                                                  {% endfor %}
                                                  <input type="text" id="is_async_{{functi}}" name="is_async_{{functi}}" value="true" style="display: none;">
                                                  <input type="submit" class="btn btn-primary" id="submit_{{functi}}" value="Test {{functi}}">
                                                </form>
                                                <form id="switchFunctionMap">
                                                  {% csrf_token %}
                                                  <div class="custom-control custom-switch">
                                                    <input type="checkbox" class="custom-control-input" id="checkSwitchFunctionMap" {% if status_pool %} checked {% endif %}>
                                                    <label class="custom-control-label" for="checkSwitchFunctionMap">On/Off in map</label>
                                                  </div>
                                                  <!--<input id="checkSwitchPool" type="checkbox" style="border: 0px !important;" data-toggle="toggle" data-on="Enabled" data-off="Disabled" data-size="small" data-offstyle="danger" data-onstyle="{% if pool_list|length > 0 %}success{% else %}primary{% endif %}" {% if status_pool %}checked{% endif %}>-->
                                                </form>
                                                <script>
                                                  $(function() {
                                                    $('#checkSwitchFunctionMap').change(function(e) {
                                                      e.preventDefault();
                                                      //$("#switchPoolForm").submit();
                                                      $.ajax({
                                                        headers: { "X-CSRFToken": '{{csrf_token}}' },
                                                        url : "{% url 'switchFunctionMap' %}", // the endpoint
                                                        type : "POST", // http method
                                                        async: true,
                                                        data : { csrfmiddlewaretoken : '{{ csrf_token }}' , module : 'ht_{{ name }}', functionName : '{{ functi }}'}
                                                      });
                                                    })
                                                  })
                                                </script>
                                              </div>
                                            <script>
                                              $("#form_{{data_value}}").on('submit',(function(e) {
                                                e.preventDefault();
                                                var form = $('#form_{{data_value}}');

                                                $.ajax({
                                                    url: '{% url data_value %}',
                                                    type: "POST",
                                                    data: new FormData($('#form_{{data_value}}')[0]),
                                                    async: true,
                                                    enctype: 'multipart/form-data',
                                                    contentType: false,
                                                    cache: false,
                                                    processData: false,
                                                    success : function(res) {
                                                      if('data' in res && res.data && Object.keys(res.data).length !== 0){
                                                        function isDict(v) {
                                                            return !!v && typeof v==='object' && v!==null && !(v instanceof Array) && !(v instanceof Date);
                                                        }
                                                        if(isDict(res.data)){
                                                          data = JSON.stringify(res.data, null, 2);
                                                          $.notify("{{functi}}:\n" + data, "success");
                                                          if($('#resultsLogger').val() != ''){
                                                            $('#resultsLogger').val("-----------------\n" + $('#resultsLogger').val())
                                                          }
                                                          $('#resultsLogger').val("{{functi}}:\n" + data + "\n" + $('#resultsLogger').val())
                                                        } else {
                                                          if(res.data instanceof Array){
                                                            var data = '';
                                                            for(var i=0; i < res.data.length; i++){
                                                              data += res.data[i];
                                                              if(res.data.length-1 != i){
                                                                data += "\n";
                                                              }
                                                            }
                                                            $.notify("{{functi}}:\n" + data, "success");
                                                            if($('#resultsLogger').val() != ''){
                                                              $('#resultsLogger').val("-----------------\n" + $('#resultsLogger').val())
                                                            }
                                                            $('#resultsLogger').val("{{functi}}:\n" + data + "\n" + $('#resultsLogger').val())
                                                          } else {
                                                            /*$('#popup_textarea').val(data)
                                                            $('#popup').modal('show');*/
                                                            $.notify("{{functi}}:\n" + res.data, "success");
                                                            if($('#resultsLogger').val() != ''){
                                                              $('#resultsLogger').val("-----------------\n" + $('#resultsLogger').val())
                                                            }
                                                            $('#resultsLogger').val("{{functi}}:\n" + res.data + "\n" + $('#resultsLogger').val())
                                                          }
                                                        }
                                                      } else {
                                                        /*$('#popup_textarea').val(res)
                                                        $('#popup').modal('show');*/
                                                        $.notify("{{functi}} - " + res, "warn");
                                                        if($('#resultsLogger').val() != ''){
                                                          $('#resultsLogger').val("-----------------\n" + $('#resultsLogger').val())
                                                        }
                                                        $('#resultsLogger').val("{{functi}}:\n" + res + "\n" + $('#resultsLogger').val())
                                                      }
                                                    },
                                                    error : function(xhr,errmsg,err) {
                                                      /*console.log(xhr.status + ": " + xhr.responseText);*/
                                                      $.notify("{{functi}} - " + res, "error");
                                                      if($('#resultsLogger').val() != ''){
                                                        $('#resultsLogger').val("-----------------\n" + $('#resultsLogger').val())
                                                      }
                                                      $('#resultsLogger').val("{{functi}}:\n" + res + "\n" + $('#resultsLogger').val())
                                                    }
                                                });
                                                return false;
                                              }));
                                              $('#submit_{{functi}}').submit(function(e) {
                                                e.preventDefault();
                                                $('form_{{data_value}}').submit(upload);
                                              });
                                            </script>
                                          {% endif %}
                                        {% endfor %}
                                      </div>
                                    </div>
                                  </div>
                                  <script>
                                    $("#function_background_{{name}}_{{funct_name}}").ready(function(){
                                      $("#function_background_{{name}}_{{funct_name}}").removeClass("bg-dark");
                                      $("#function_background_{{name}}_{{funct_name}}").addClass("bg-info");
                                    });
                                  </script>
                                {% endif %}
                              {% endfor %}
                            {% endfor %}
                            <a href="#" data-toggle="modal" data-target="#testModuleFunctionModal_ht_{{name}}_{{funct_name}}">
                              <div class="card bg-dark text-white shadow mouseOverFunction" id="function_background_{{name}}_{{funct_name}}">
                                <div class="card-body">
                                  {{funct_name}}
                                  {% for i, param in funct_params.items %}
                                    {% if param %}
                                    <div class="text-white-50 small">{{param}}</div>
                                    {% else %}
                                    <div class="text-white-50 small">No params</div>
                                    {% endif %}
                                  {% endfor %}
                                </div>
                              </div>
                            </a>
                          {% endif %}
                        {% endfor %}
                      {% else %}
                        <div class="card bg-secondary text-white shadow mouseOverFunction">
                          <div class="card-body">
                            No functions
                          </div>
                        </div>
                      {% endif %}
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <input type="submit" class="btn btn-primary" value="Save script"></button>
            </div>
          </div>
        </div>
      </div>
      <!-- Earnings (Monthly) Card Example -->
      <div class="col-xl-3 col-md-6 mb-4">
        <a href="#" data-toggle="modal" data-target="#createScriptModuleModal">
          <div class="card border-left-primary shadow h-100 py-2 overMouseButtons">
            <div class="card-body">
              <div class="row no-gutters align-items-center">
                <div class="col mr-2">
                  <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Try creating your own script</div>
                  <div class="h5 mb-0 font-weight-bold text-gray-800">Create Script</div>
                </div>
                <div class="col-auto">
                  <i class="fas fa-folder fa-2x text-gray-300"></i>
                </div>
              </div>
            </div>
          </div>
        </a>
      </div>

      <!-- Pending Requests Card Example -->
      <div class="modal fade" id="testModuleModal" tabindex="-1" role="dialog" aria-labelledby="testModuleLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="testModuleLabel">Test your Module</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="col-xl-3 col-md-6 mb-4">
        <a href="#" data-toggle="modal" data-target="#testModuleModal">
          <div class="card border-left-warning shadow h-100 py-2 overMouseButtons">
            <div class="card-body">
              <div class="row no-gutters align-items-center">
                <div class="col mr-2">
                  <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Test created Modules</div>
                  <div class="h5 mb-0 font-weight-bold text-gray-800">Test Module-Scripting</div>
                </div>
                <div class="col-auto">
                  <i class="fas fa-hashtag fa-2x text-gray-300"></i>
                </div>
              </div>
            </div>
          </div>
        </a>
      </div>
    </div>

    <!-- Content Row -->
    <div class="row">
      <div class="col-lg-6 mb-4">
        <div class="row">
          {% for mod, modform in modules_forms.items %}
            <div class="modal fade" id="{{mod}}_test" tabindex="-1" role="dialog" aria-labelledby="{{mod}}_test_label" aria-hidden="true">
              <div class="modal-dialog" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="{{mod}}_test_label">Module: {{mod}}</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  {% for urlmodform, form in modform.items %}
                    <form action="{% url urlmodform %}" method="post" enctype="multipart/form-data">
                      {% csrf_token %}
                      {{form|safe}}
                    </form>
                  {% endfor %}
                  <!--<div id="console_command">{{console_command}}</div>-->
                </div>
              </div>
            </div>
          {% endfor %}
          {% for mod in modules %}
            <div id="remove-{{mod}}" class="modal fade bd-example-modal-sm" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">
              <div class="modal-dialog modal-sm">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="createModuleLabel">Remove {{mod}}</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <span>Sure you want to remove the module {{mod}}?</span>
                    <span>For deleting, enter below: <b>{{mod}}</b></span>
                    <input type="text" class="form-control" id="removeMod_{{mod}}"/>
                  </div>
                </div>
              </div>
            </div>
            <script>
              function removeModule{{mod}}(evt) {
                evt.preventDefault();
                var txt;
                var person = prompt("Sure you want to remove the module {{mod}}?\n\nFor deleting, enter below: '{{mod}}'", "");
                if (person == "{{mod}}") {
                  $.ajax({
                    url: "{% url 'removeModule' %}",
                    method: "POST",
                    data: {
                      module_name :'{{mod}}',
                      csrfmiddlewaretoken : '{{ csrf_token }}'
                    },
                    success: function(result){
                      $.notify("{{mod}}:\n" + result['data'], "success");
                      if($('#resultsLogger').val() != ''){
                        $('#resultsLogger').val("-----------------\n" + $('#resultsLogger').val())
                      }
                      $('#resultsLogger').val("Remove {{mod}}:\n" + result['data'] + "\n" + $('#resultsLogger').val())
                      $.notify("Restart Server:\n RESTART NEEDED", "warn");
                      /*$.ajax({
                        url: "{% url 'restartServerDjango' %}",
                        method: "POST",
                        success: function(res){
                          $.notify("Restart server:\n" + res['data'], "warn");
                          changeGif(Math.floor(Math.random() * 4) + 1);
                          $('#reloading-server').modal('show');
                        }
                      });*/
                    },
                    error(){
                      $.notify("{{mod}}:\nSomething wen't wrong", "error");
                      $('#reloading-server').modal('hide');
                    }
                  });
                } else {
                  $.notify("Bad module name", "error");
                  $('#reloading-server').modal('hide');
                }
              }
            </script>
            <div class="col-lg-4 mb-3">
              <a href="#" data-toggle="modal" data-target="#{{mod}}_test">
                <div class="card bg-success text-white shadow mouseOverModule">
                  <div class="card-body">
                    <i class="icon-trash" style="float: right;" onclick="removeModule{{mod}}(event);"></i>
                    {{mod}}
                    <div class="text-white-50 small">Module</div>
                  </div>
                </div>
              </a>
            </div>
          {% endfor %}
          {% for mod in modules_names_repo %}
            {% if not mod in modules %}
              <div class="col-lg-4 mb-3">
                <a href="#" id="download_{{mod}}">
                  <div class="card bg-secondary text-white shadow mouseOverModule">
                    <div class="card-body">
                      {{mod}}
                      <div class="text-white-50 small">Download Module</div>
                    </div>
                  </div>
                </a>
                <script>
                  $('#download_{{mod}}').click(function(){
                    $.ajax({
                      url: "{% url 'downloadInstallModule' %}",
                      method: "POST",
                      data: {
                        module_name :'{{mod}}',
                        csrfmiddlewaretoken : '{{ csrf_token }}'
                      },
                      success: function(result){
                        $.notify("{{mod}}:\n" + result['data'], "success");
                        if($('#resultsLogger').val() != ''){
                          $('#resultsLogger').val("-----------------\n" + $('#resultsLogger').val())
                        }
                        $('#resultsLogger').val("Download {{mod}}:\n" + result['data'] + "\n" + $('#resultsLogger').val())
                        $.notify("Restart Server:\n RESTART NEEDED", "warn");
                        /*$.ajax({
                          url: "{% url 'restartServerDjango' %}",
                          method: "POST",
                          success: function(res){
                            $.notify("Restart server:\n" + res['data'], "warn");
                            changeGif(Math.floor(Math.random() * 4) + 1);
                            $('#reloading-server').modal('show');
                          }
                        });*/
                      },
                      error(){
                        $.notify("{{mod}}:\nSomething wen't wrong", "error");
                        $('#reloading-server').modal('hide');
                      }
                    });
                  });
                </script>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>

      <!-- Content Column -->
      <div class="col-lg-6 mb-4">

        <!-- Color System -->
        <div class="row">
          {% for cat in categories %}
            <div class="col-lg-4 mb-3">
              <div class="card bg-primary text-white shadow mouseOverCategory">
                <div class="card-body">
                  {{cat}}
                  <div class="text-white-50 small">Category</div>
                </div>
              </div>
            </div>
          {% endfor %}
          {% for cat in categories_names_repo %}
            {% if not cat in categories %}
              <div class="col-lg-4 mb-3">
                <div class="card bg-secondary text-white shadow mouseOverCategory">
                  <div class="card-body">
                    {{cat}}
                    <div class="text-white-50 small">Category</div>
                  </div>
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>

    </div>
  </div>
  <!-- Bottombar -->
  <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow console-logger-nav">
    {% comment %} 
    <!-- Sidebar Toggle (Topbar) -->
    <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
      <i class="fa fa-bars"></i>
    </button>

    <!-- Topbar Search -->
    <form class="d-none d-sm-inline-block form-inline mr-auto ml-md-3 my-2 my-md-0 mw-100 navbar-search">
      <div class="input-group">
        <input type="text" class="form-control bg-light border-0 small" placeholder="Search for..." aria-label="Search" aria-describedby="basic-addon2" />
        <div class="input-group-append">
          <button class="btn btn-primary" type="button">
            <i class="fas fa-search fa-sm"></i>
          </button>
        </div>
      </div>
    </form>

    <!-- Topbar Navbar -->
    <ul class="navbar-nav ml-auto">

      <!-- Nav Item - Search Dropdown (Visible Only XS) -->
      <li class="nav-item dropdown no-arrow d-sm-none">
        <a class="nav-link dropdown-toggle" href="{% url 'home' %}" id="searchDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          <i class="fas fa-search fa-fw"></i>
        </a>
        <!-- Dropdown - Messages -->
        <div class="dropdown-menu dropdown-menu-right p-3 shadow animated--grow-in" aria-labelledby="searchDropdown">
          <form class="form-inline mr-auto w-100 navbar-search">
            <div class="input-group">
              <input type="text" class="form-control bg-light border-0 small" placeholder="Search for..." aria-label="Search" aria-describedby="basic-addon2" />
              <div class="input-group-append">
                <button class="btn btn-primary" type="button">
                  <i class="fas fa-search fa-sm"></i>
                </button>
              </div>
            </div>
          </form>
        </div>
      </li>

    </ul> {% endcomment %}

    <!-- Bottom Console -->
    <div id="reloading-server" class="modal fade bd-example-modal-sm" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true"  data-keyboard="false" data-backdrop="static">
      <div class="modal-dialog modal-sm">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="createModuleLabel">Reloading Server...</h5>
            <span style='font-size:24px;'>&#9201;</span>
          </div>
          <div class="modal-body loading-gif">
            <img id="loadinggif" src="" alt="Reloading Server. Please Wait...">
          </div>
        </div>
      </div>
    </div>
    <script>
      gif_to_load_num = Math.floor(Math.random() * 4) + 1;
      switch (gif_to_load_num) {
        case 1:
          $("#loadinggif").attr("src", "{% static 'core/img/loading1.gif' %}");
        case 2:
          $("#loadinggif").attr("src", "{% static 'core/img/loading2.gif' %}");
        case 3:
          $("#loadinggif").attr("src", "{% static 'core/img/loading3.gif' %}");
        case 4:
          $("#loadinggif").attr("src", "{% static 'core/img/loading4.gif' %}");
      }
      function changeGif(num){
        switch (num) {
          case 1:
            $("#loadinggif").attr("src", "{% static 'core/img/loading1.gif' %}");
          case 2:
            $("#loadinggif").attr("src", "{% static 'core/img/loading2.gif' %}");
          case 3:
            $("#loadinggif").attr("src", "{% static 'core/img/loading3.gif' %}");
          case 4:
            $("#loadinggif").attr("src", "{% static 'core/img/loading4.gif' %}");
        }
      }

    </script>
    <form class="d-none d-sm-inline-block form-inline mr-auto my-2 my-md-0 mw-100 navbar-search" id="bottomConsoleResultBar">
      <textarea class="form-control logger-results" id="resultsLogger" rows="4" spellcheck="false" aria-describedby="basic-addon2" placeholder="Waiting Results..." disabled></textarea>
      <div class="form-control logger-console" id="consoleLogger" rows="4" spellcheck="false" aria-describedby="basic-addon2" placeholder="Loading Logger..."disabled>
        <div>
          <table>
            <tr>
              <td class="consoleLogger-row">
                <div class="custom-control custom-switch">
                  <input type="checkbox" class="custom-control-input" id="consoleLogger-filter-success" checked>
                  <label class="custom-control-label consoleSwitchFilter text-success" for="consoleLogger-filter-success"><b>SUCCESS</b></label>
                </div>
              </td>
              <td class="consoleLogger-row">
                <div class="custom-control custom-switch">
                  <input type="checkbox" class="custom-control-input" id="consoleLogger-filter-error" checked>
                  <label class="custom-control-label consoleSwitchFilter text-danger" for="consoleLogger-filter-error"><b>ERROR</b></label>
                </div>
              </td>
              <td class="consoleLogger-row">
                <div class="custom-control custom-switch">
                  <input type="checkbox" class="custom-control-input" id="consoleLogger-filter-warn" checked>
                  <label class="custom-control-label consoleSwitchFilter text-warning" for="consoleLogger-filter-warn"><b>WARN</b></label>
                </div>
              </td>
              <td class="consoleLogger-row">
                <div class="custom-control custom-switch">
                  <input type="checkbox" class="custom-control-input" id="consoleLogger-filter-info" checked>
                  <label class="custom-control-label consoleSwitchFilter text-info" for="consoleLogger-filter-info"><b>INFO</b></label>
                </div>
              </td>
              <td class="consoleLogger-row">
                <div class="custom-control custom-switch">
                  <input type="checkbox" class="custom-control-input" id="consoleLogger-filter-core" checked>
                  <label class="custom-control-label consoleSwitchFilter text-secondary" for="consoleLogger-filter-core"><b>CORE</b></label>
                </div>
              </td>
              <td class="consoleLogger-row">
                <div class="custom-control custom-switch">
                  <input type="checkbox" class="custom-control-input" id="consoleLogger-filter-module" checked>
                  <label class="custom-control-label consoleSwitchFilter text-default" for="consoleLogger-filter-module"><b>MODULE</b></label>
                </div>
              </td>
          </tr>
          </table>
        </div>
        <hr style="margin: 2px auto !important;">
        <div id="consoleLogger-content" name="consoleLogger-content"></div>
      </div>
    </form>
    <script>
    function expandTextarea(id) {
        document.getElementById(id).addEventListener('keyup', function() {
            this.style.overflow = 'hidden';
            this.style.height = 0;
            this.style.height = this.scrollHeight + 'px';
        }, false);
    }
    //expandTextarea('consoleLogger');
    timer_clicktime = 200
    length_console_logs = 0
    buttonsPoolChecked = false
    var timer = {
      running: false,
      iv: timer_clicktime,
      timeout: false,
      cb : function(){},
      start : function(cb,iv){
          var elm = this;
          clearInterval(this.timeout);
          this.running = true;
          if(cb) this.cb = cb;
          if(iv) this.iv = iv;
          this.timeout = setTimeout(function(){elm.execute(elm)}, this.iv);
      },
      execute : function(e){
          if(!e.running) return false;
          e.cb();
          e.start();
      },
      stop : function(){
          this.running = false;
      },
      set_interval : function(iv){
          clearInterval(this.timeout);
          this.start(false, iv);
      }
    };
    error_counter_for_reload_message = 0

    function switchPoolButtons(){
      $.each($('.toggle'), function(){
        if ($(this).children('input[id^="__pool_it_"]')){
          $(this).click();
        }
      });
    }

    timer.start(function(){
      $.ajax({
        url : "{% url 'getLogs' %}", // the endpoint
        type : "POST", // http method
        async: true,
        data: { csrfmiddlewaretoken : '{{ csrf_token }}' },
        success : function(res) {
          if ('buttonsPool' in res) {
            if (res.buttonsPool == true && buttonsPoolChecked == false) {
              switchPoolButtons();
              buttonsPoolChecked = true;
            } else {
              if (res.buttonsPool == false && buttonsPoolChecked == true) {
                switchPoolButtons();
                buttonsPoolChecked = false;
              }
            }
          }
          if ('data' in res && res.data && Object.keys(res.data).length !== 0){ // && length_console_logs !== Object.keys(res.data).length
            $('#reloading-server').modal('hide');
            $('#consoleLogger-content').empty();
            res_data_keys = Object.keys(res.data).reverse()
            for (var logtime in res_data_keys) {
              data_result = '';
              if (res.data.hasOwnProperty(res_data_keys[logtime])) {
                data_result += "[" + res_data_keys[logtime] + "] " + res.data[res_data_keys[logtime]] + "\n";
                if (data_result.includes('ERROR') && $('#consoleLogger-filter-error').is(':checked')) {
                  data_result = "<p class=\"text-danger\">" + data_result.split("[ERROR] - ")[0] + " - " + data_result.split("[ERROR] - ")[1] + "</p>";
                } else if (data_result.includes('WARN') && $('#consoleLogger-filter-warn').is(':checked')) {
                  data_result = "<p class=\"text-warning\">" + data_result.split("[WARN] - ")[0] + " - " + data_result.split("[WARN] - ")[1] + "</p>";
                } else if (data_result.includes('INFO') && $('#consoleLogger-filter-info').is(':checked')) {
                  data_result = "<p class=\"text-info\">" + data_result.split("[INFO] - ")[0] + " - " + data_result.split("[INFO] - ")[1] + "</p>";
                } else if (data_result.includes('SUCCESS') && $('#consoleLogger-filter-success').is(':checked')) {
                  data_result = "<p class=\"text-success\">" + data_result.split("[SUCCESS] - ")[0] + " - " + data_result.split("[SUCCESS] - ")[1] + "</p>";
                } else if (data_result.includes('CORE') && $('#consoleLogger-filter-core').is(':checked')) {
                  data_result = "<p class=\"text-secondary\">" + data_result.split("[CORE] - ")[0] + " - " + data_result.split("[CORE] - ")[1] + "</p>";
                } else if (data_result.includes('MODULE') && $('#consoleLogger-filter-module').is(':checked')) {
                  data_result = "<p class=\"text-default\">" + data_result.split("[MODULE] - ")[0] + " - " + data_result.split("[MODULE] - ")[1] + "</p>";
                } else {
                  data_result = '';
                } /*else if ((data_result.includes('ERROR') == false && $('#consoleLogger-filter-error').is(':checked')) || (data_result.includes('WARN') == false && $('#consoleLogger-filter-warn').is(':checked')) || (data_result.includes('INFO') == false && $('#consoleLogger-filter-info').is(':checked')) || (data_result.includes('SUCCESS') == false && $('#consoleLogger-filter-success').is(':checked')) || (data_result.includes('CORE') == false && $('#consoleLogger-filter-core').is(':checked')) || (data_result.includes('MODULE') == false && $('#consoleLogger-filter-module').is(':checked'))){
                  data_result = "<p class=\"text-muted\">" + data_result + "</p>";
                }*/
              }
              $('#consoleLogger-content').append(data_result);
            }
            timer.set_interval(2000);
            length_console_logs = Object.keys(res.data).length;
            if (error_counter_for_reload_message > 4){
              error_counter_for_reload_message = 0;
              location.reload();
            }
          } else {
            // $('#consoleLogger').val('Loading Log...')
            if (error_counter_for_reload_message > 4){
              error_counter_for_reload_message = 0;
              location.reload();
            }
            timer.set_interval(5000);
          }
        },
        error : function(xhr,errmsg,err) {
          error_counter_for_reload_message = error_counter_for_reload_message + 1
          console.log(xhr.status + ": " + xhr.responseText);
          if (error_counter_for_reload_message > 2){
            $.each($('.modal'), function(){
              if ($(this).attr('id') != 'reloading-server'){
                $(this).modal('hide');
              }
            });
            $('#reloading-server').modal('show');
          }
        }
      });
    }, timer_clicktime );
    
    </script>

  </nav>
  <!-- End of Bottombar -->

  <!-- /.container-fluid -->

  </div>
  <!-- End of Main Content -->
</div>
{% endblock %}