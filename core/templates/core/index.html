{% extends 'core/base.html' %}
{% load static %}
{% block content %}
    {% if popup_text %}
      <script type="text/javascript">
        $(window).on('load',function(){
          $('#popup').modal('show');
        });
        function copyToClipboard() {
          var copyText = document.getElementById("popup_textarea");
          copyText.select();
          document.execCommand("copy");
          $('#popup').modal('hide');
        }
      </script>
    {% endif %}
    <div class="modal fade" id="popup" tabindex="-1" role="dialog" aria-labelledby="responseLabel" aria-hidden="true" style="z-index: 11111;">
      <div class="modal-dialog modal-dialog-pop-up" role="document">
        <div class="modal-content" style="height: 500px;">
          <div class="modal-header">
            <h5 class="modal-title" id="responseLabel">Response:</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <textarea id="popup_textarea" class="form-control">{{popup_text|safe}}</textarea>
          </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <input type="button" class="btn btn-primary" value="Copy to the clipboard" onclick="copyToClipboard()"></button>
            </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="pool_list" tabindex="-1" role="dialog" aria-labelledby="pool_list_modal" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <form action="{% url 'add_pool_node' %}" method="post">
            {% csrf_token %}
            <div class="modal-header">
              <h5 class="modal-title" id="pool_list_modal">Pool List:</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <input name="pool_ip" class="form-control bg-light border-0 small col-md-6 mb-4" placeholder="https://1.2.3.4:8000" required/>
              <textarea class="form-control">{{ pool_list | join:"&#10;" }}</textarea>
              <h5 class="modal-title">My services:</h5>
              <textarea class="form-control">{{ my_services | join:"&#10;" }}</textarea>
              <input type="text" id="is_async_add_pool_node" name="is_async_add_pool_node" value="true" style="display: none;">
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <input type="submit" class="btn btn-primary" value="Add pool node"></button>
            </div>
          </form>
          {% if not ngrokService %}
            <div class="modal-body">
              <hr class='sidebar-divider my-0 my-separator'>
              <div style="display: flex;">
                <form action="{% url 'startNgrok' %}" method="post" id="startNgrok" name="startNgrok" style="margin: 0 10px;">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-info">Init ngrok</button>
                </form>
                <form action="{% url 'startNgrok' %}" method="post" id="startNgrok" name="startNgrok" style="margin: 0 10px;">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-info">Init ngrok</button>
                </form>
                <form action="{% url 'startNgrok' %}" method="post" id="startNgrok" name="startNgrok" style="margin: 0 10px;">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-info">Init ngrok</button>
                </form>
              </div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
      <h1 class="h3 mb-0 text-gray-800">Dashboard</h1>
      <div class="d-sm-flex align-items-center justify-content-between mb-6">
        {% comment %} <input type="text" class="form-control" id="my_pool_id" value="{{my_node_id_pool}}" size="{{my_node_id_pool|length}}" onfocus="copyNodeIdToClipboard()" readonly/> |  {% endcomment %}
        <form id="switchPoolForm">
          {% csrf_token %}
          <div class="custom-control custom-switch">
            <input type="checkbox" class="custom-control-input" id="checkSwitchPool" {% if status_pool %} checked {% endif %}>
            <label class="custom-control-label" for="checkSwitchPool">On/Off the Pool</label>
          </div>
          <!--<input id="checkSwitchPool" type="checkbox" style="border: 0px !important;" data-toggle="toggle" data-on="Enabled" data-off="Disabled" data-size="small" data-offstyle="danger" data-onstyle="{% if pool_list|length > 0 %}success{% else %}primary{% endif %}" {% if status_pool %}checked{% endif %}>-->
        </form>
        <script>
          $(function() {
            $('#checkSwitchPool').change(function(e) {
              e.preventDefault();
              //$("#switchPoolForm").submit();
              $.ajax({
                headers: { "X-CSRFToken": '{{csrf_token}}' },
                url : "{% url 'switchPool' %}", // the endpoint
                type : "POST", // http method
                async: true,
                success : function(res) {
                    if('status' in res && res.status == true){
                      $('input:checkbox[id^="__pool_it_"]').each(function(){
                        document.getElementById($(this).attr('id')).parentElement.parentElement.style.display = "block";
                      });
                    } else {
                      if('status' in res && res.status == false){
                        $('input:checkbox[id^="__pool_it_"]').each(function(){
                          var a = document.getElementById($(this).attr('id')).parentElement.parentElement.style.display = "None";
                        });
                      }
                    }
                },
                error : function(xhr,errmsg,err) {
                    console.log(xhr.status + ": " + xhr.responseText);
                }
              });
            })
          })
        </script>
        <a href="#" href="#" data-toggle="modal" data-target="#pool_list" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm"><i class="fas fa-upload fa-sm text-white-50"></i> Pool List ({{pool_list|length}})</a> | 
        <a href="{% url 'config_look_for_changes' %}" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm"><i class="fas fa-download fa-sm text-white-50"></i> Refresh Config</a>
      </div>
    </div>

    <!-- Content Row -->
    <div class="row">
      <!-- Modal create Module -->
      <div class="modal fade" id="createModuleModal" tabindex="-1" role="dialog" aria-labelledby="createModuleLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <form action="{% url 'createmod' %}" method="post">
              {% csrf_token %}
              <div class="modal-header">
                <h5 class="modal-title" id="createModuleLabel">Create new Module</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <input name="module_name" class="form-control bg-light border-0 small col-md-6 mb-4" placeholder="Module name" required/>
                <span>Category:</span><br />
                <select id="editable-select" name="category_name" class="custom-select custom-select-sm form-control form-control-sm col-xl-3 col-md-6 mb-4">
                  {% for cat in categories %}
                    <option value="{{cat}}">{{cat}}</option>
                  {% endfor %}
                </select>
                <script>
                  $('#editable-select').editableSelect();
                </script>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <input type="submit" class="btn btn-primary" value="Save changes"></button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <div class="col-xl-3 col-md-6 mb-4">
        <a href="#" data-toggle="modal" data-target="#createModuleModal">
          <div class="card border-left-success shadow h-100 py-2 overMouseButtons">
            <div class="card-body">
              <div class="row no-gutters align-items-center">
                <div class="col mr-2">
                  <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">{{modules|length}} Modules - {{categories|length}} Categories Loaded</div>
                  <div class="h5 mb-0 font-weight-bold text-gray-800">Create Module</div>
                </div>
                <div class="col-auto">
                  <i class="fas fa-edit fa-2x text-gray-300"></i>
                </div>
              </div>
            </div>
          </div>
        </a>
      </div>

      <!-- Modal config Module -->
      <div class="modal fade" id="configModuleModal" tabindex="-1" role="dialog" aria-labelledby="configModuleLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-bigger" role="document">
          <div class="modal-content">
            <form action="{% url 'configmod' %}" method="post">
              {% csrf_token %}
              <div class="modal-header">
                <h5 class="modal-title" id="configModuleLabel">Configure Module</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <div class="container">
                  <div id="bs-ml-treetable" class="treetable">
                    Loading ...
                  </div>
                </div>
                <script type="text/javascript" src="{% static 'core/js/jquery.edittreetable.js' %}"></script>
                <script type="text/javascript">
                  var data = [{{modules_config_treeview|safe}}];

                  $("#bs-ml-treetable").bstreetable({
                    data:data,
                    maintitle:"Key",
                    nodeaddCallback:function(data,callback){
                      alert(JSON.stringify(data));
                      callback({id:18,name:data.name,innercode:"ttttt",pid:data.pid});
                    },
                    noderemoveCallback:function(data,callback){
                      alert(JSON.stringify(data));
                      callback();
                    },
                    nodeupdateCallback:function(data,callback){
                      alert(JSON.stringify(data));
                      callback();
                    },
                    extfield:[
                      {title:"Value",key:"value",type:"input"}
                    ]
                  });
                </script>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <input type="submit" class="btn btn-primary" value="Save module"></button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <!-- Earnings (Monthly) Card Example -->
      <div class="col-xl-3 col-md-6 mb-4">
        <a href="#" data-toggle="modal" data-target="#configModuleModal">
          <div class="card border-left-info shadow h-100 py-2 overMouseButtons">
            <div class="card-body">
              <div class="row no-gutters align-items-center">
                <div class="col mr-2">
                  <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Change your configuration</div>
                  <div class="h5 mb-0 font-weight-bold text-gray-800">Config Modules</div>
                </div>
                <div class="col-auto">
                  <i class="fas fa-cogs fa-2x text-gray-300"></i>
                </div>
              </div>
            </div>
          </div>
        </a>
      </div>

      <!-- Modal create Script -->
      <div class="modal fade" id="createScriptModuleModal" tabindex="-1" role="dialog" aria-labelledby="createScriptModuleLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-bigger" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="createScriptModuleLabel">Create Script</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body modal-body-limited">
              <div class="row">
                {% for name, funct in modules_all.items %}
                  <div class="col-lg-3 mb-3">
                    <h3>{{name}}</h3>
                    <div class="moduleFunctions">
                      {% if funct.items|length > 1 %}
                        {% for funct_name, funct_params in funct.items %}
                          {% if funct_name != 'help' %}
                            {% for tool, function in modules_functions_modals.items %}
                              {% for functi, data in function.items %}
                                {% if functi == funct_name and 'ht_'|add:name == tool %}
                                  <!-- MODAL PARA LA FUNCTION -->
                                  <div class="modal fade" id="testModuleFunctionModal_{{tool}}_{{functi}}" tabindex="-1" role="dialog" aria-labelledby="testModuleFunctionModalLabel_{{tool}}_{{functi}}" aria-hidden="true">
                                    <div class="modal-dialog" role="document">
                                      <div class="modal-content">
                                        {% for data_key, data_value in data.items %}
                                          {% if data_key in '__function__' %}
                                              <div class="modal-header">
                                                <h5 class="modal-title" id="testModuleFunctionModalLabel_{{tool}}_{{functi}}">Test {{functi}}</h5>
                                              </div><!-- -->
                                              <div class="modal-body">
                                                <form action="{% url data_value %}" method="post" enctype="multipart/form-data" id="form_{{data_value}}">
                                                  {% csrf_token %}
                                                  {% for mod, modform in modules_forms_modal.items %}
                                                    {% for f_name, f_data_form in modform.items %}
                                                      {% if f_name == functi %}
                                                        {{f_data_form|safe}}
                                                      {% endif %}
                                                    {% endfor %}
                                                  {% endfor %}
                                                  <input type="text" id="is_async_{{functi}}" name="is_async_{{functi}}" value="true" style="display: none;">
                                                  <input type="submit" class="btn btn-primary" id="submit_{{functi}}" value="Test {{functi}}">
                                                </form>
                                              </div>
                                            <script>
                                              $("#form_{{data_value}}").on('submit',(function(e) {
                                                e.preventDefault();
                                                var form = $('#form_{{data_value}}');

                                                $.ajax({
                                                    url: form.attr('action'),
                                                    type: "POST",
                                                    data: new FormData($('#form_{{data_value}}')[0]),
                                                    async: true,
                                                    enctype: 'multipart/form-data',
                                                    contentType: false,
                                                    cache: false,
                                                    processData: false,
                                                    success : function(res) {
                                                      if('data' in res && res.data && Object.keys(res.data).length !== 0){
                                                        function isDict(v) {
                                                            return !!v && typeof v==='object' && v!==null && !(v instanceof Array) && !(v instanceof Date) && isJsonable(v);
                                                        }
                                                        if(isDict(res.data)){
                                                          data = JSON.stringify(res.data, null, 2);
                                                          $.notify("{{functi}}:\n" + data, "success");
                                                        } else {
                                                          if(res.data instanceof Array){
                                                            var data = '';
                                                            for(var i=0; i < res.data.length; i++){
                                                              data += "\n" + res.data[i];
                                                            }
                                                            $.notify("{{functi}}: " + data, "success");
                                                          } else {
                                                            /*$('#popup_textarea').val(data)
                                                            $('#popup').modal('show');*/
                                                            $.notify("{{functi}}:\n" + res.data, "success");
                                                          }
                                                        }
                                                      } else {
                                                        /*$('#popup_textarea').val(res)
                                                        $('#popup').modal('show');*/
                                                        $.notify("{{functi}} - " + res, "warn");
                                                      }
                                                    },
                                                    error : function(xhr,errmsg,err) {
                                                      /*console.log(xhr.status + ": " + xhr.responseText);*/
                                                      $.notify("{{functi}} - " + res, "error");
                                                    }
                                                });
                                                return false;
                                              }));
                                              $('#submit_{{functi}}').submit(function(e) {
                                                e.preventDefault();
                                                $('form_{{data_value}}').submit(upload);
                                              });
                                            </script>
                                          {% endif %}
                                        {% endfor %}
                                      </div>
                                    </div>
                                  </div>
                                  <script>
                                    $("#function_background_{{name}}_{{funct_name}}").ready(function(){
                                      $("#function_background_{{name}}_{{funct_name}}").removeClass("bg-dark");
                                      $("#function_background_{{name}}_{{funct_name}}").addClass("bg-info");
                                    });
                                  </script>
                                {% endif %}
                              {% endfor %}
                            {% endfor %}
                            <a href="#" data-toggle="modal" data-target="#testModuleFunctionModal_ht_{{name}}_{{funct_name}}">
                              <div class="card bg-dark text-white shadow mouseOverFunction" id="function_background_{{name}}_{{funct_name}}">
                                <div class="card-body">
                                  {{funct_name}}
                                  {% for i, param in funct_params.items %}
                                    {% if param %}
                                    <div class="text-white-50 small">{{param}}</div>
                                    {% else %}
                                    <div class="text-white-50 small">No params</div>
                                    {% endif %}
                                  {% endfor %}
                                </div>
                              </div>
                            </a>
                          {% endif %}
                        {% endfor %}
                      {% else %}
                        <div class="card bg-secondary text-white shadow mouseOverFunction">
                          <div class="card-body">
                            No functions
                          </div>
                        </div>
                      {% endif %}
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <input type="submit" class="btn btn-primary" value="Save script"></button>
            </div>
          </div>
        </div>
      </div>
      <!-- Earnings (Monthly) Card Example -->
      <div class="col-xl-3 col-md-6 mb-4">
        <a href="#" data-toggle="modal" data-target="#createScriptModuleModal">
          <div class="card border-left-primary shadow h-100 py-2 overMouseButtons">
            <div class="card-body">
              <div class="row no-gutters align-items-center">
                <div class="col mr-2">
                  <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Try creating your own script</div>
                  <div class="h5 mb-0 font-weight-bold text-gray-800">Create Script</div>
                </div>
                <div class="col-auto">
                  <i class="fas fa-folder fa-2x text-gray-300"></i>
                </div>
              </div>
            </div>
          </div>
        </a>
      </div>

      <!-- Pending Requests Card Example -->
      <div class="modal fade" id="testModuleModal" tabindex="-1" role="dialog" aria-labelledby="testModuleLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="testModuleLabel">Test your Module</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="col-xl-3 col-md-6 mb-4">
        <a href="#" data-toggle="modal" data-target="#testModuleModal">
          <div class="card border-left-warning shadow h-100 py-2 overMouseButtons">
            <div class="card-body">
              <div class="row no-gutters align-items-center">
                <div class="col mr-2">
                  <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Test created Modules</div>
                  <div class="h5 mb-0 font-weight-bold text-gray-800">Test Module-Scripting</div>
                </div>
                <div class="col-auto">
                  <i class="fas fa-hashtag fa-2x text-gray-300"></i>
                </div>
              </div>
            </div>
          </div>
        </a>
      </div>
    </div>

    <!-- Content Row -->
    <div class="row">
      <div class="col-lg-6 mb-4">
        <div class="row">
          {% for mod, modform in modules_forms.items %}
            <div class="modal fade" id="{{mod}}_test" tabindex="-1" role="dialog" aria-labelledby="{{mod}}_test_label" aria-hidden="true">
              <div class="modal-dialog" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="{{mod}}_test_label">Module: {{mod}}</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  {% for urlmodform, form in modform.items %}
                    <form action="{% url urlmodform %}" method="post" enctype="multipart/form-data">
                      {% csrf_token %}
                      {{form|safe}}
                    </form>
                  {% endfor %}
                  <!--<div id="console_command">{{console_command}}</div>-->
                </div>
              </div>
            </div>
          {% endfor %}
          {% for mod in modules %}
            <div class="col-lg-4 mb-3">
              <a href="#" data-toggle="modal" data-target="#{{mod}}_test">
                <div class="card bg-success text-white shadow mouseOverModule">
                  <div class="card-body">
                    {{mod}}
                    <div class="text-white-50 small">Module</div>
                  </div>
                </div>
              </a>
            </div>
          {% endfor %}
        </div>
      </div>

      <!-- Content Column -->
      <div class="col-lg-6 mb-4">

        <!-- Color System -->
        <div class="row">
          {% for cat in categories %}
            <div class="col-lg-4 mb-3">
              <div class="card bg-primary text-white shadow mouseOverCategory">
                <div class="card-body">
                  {{cat}}
                  <div class="text-white-50 small">Category</div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>

    </div>
  </div>
{% endblock %}